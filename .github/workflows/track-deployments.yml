name: Track Deployments

on:
  workflow_dispatch:
    inputs:
      repo_name:
        description: 'Repository name (e.g., my-repo)'
        required: true
      version:
        description: 'Version/Tag (e.g., v1.0.0)'
        required: true
      branch:
        description: 'Branch name'
        required: false
        default: 'main'
      status:
        description: 'Deployment status (success/failed)'
        required: false
        default: 'success'
  repository_dispatch:
    types: [repo-deployed]

jobs:
  update-deployments:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'
      
      - name: Parse and validate deployment info
        id: parse
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            REPO_NAME="${{ github.event.inputs.repo_name }}"
            VERSION="${{ github.event.inputs.version }}"
            BRANCH="${{ github.event.inputs.branch }}"
            STATUS="${{ github.event.inputs.status }}"
          else
            REPO_NAME="${{ github.event.client_payload.repo_name }}"
            VERSION="${{ github.event.client_payload.version }}"
            BRANCH="${{ github.event.client_payload.branch }}"
            STATUS="${{ github.event.client_payload.status }}"
          fi
          
          # Apply defaults
          BRANCH=${BRANCH:-main}
          STATUS=${STATUS:-success}
          
          # Validate required fields
          if [ -z "$REPO_NAME" ] || [ -z "$VERSION" ]; then
            echo "ERROR: repo_name and version are required"
            exit 1
          fi
          
          echo "repo_name=$REPO_NAME" >> $GITHUB_OUTPUT
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "branch=$BRANCH" >> $GITHUB_OUTPUT
          echo "status=$STATUS" >> $GITHUB_OUTPUT
          echo "timestamp=$(date -u +'%Y-%m-%dT%H:%M:%SZ')" >> $GITHUB_OUTPUT
      
      - name: Update deployments.json
        env:
          REPO_NAME: ${{ steps.parse.outputs.repo_name }}
          VERSION: ${{ steps.parse.outputs.version }}
          BRANCH: ${{ steps.parse.outputs.branch }}
          STATUS: ${{ steps.parse.outputs.status }}
          TIMESTAMP: ${{ steps.parse.outputs.timestamp }}
        run: |
          cat > update_deployments.py << 'PYTHON_EOF'
          import json
          import os

          # Get values from environment
          repo_name = os.environ.get('REPO_NAME')
          version = os.environ.get('VERSION')
          branch = os.environ.get('BRANCH', 'main')
          status = os.environ.get('STATUS', 'success')
          timestamp = os.environ.get('TIMESTAMP')

          # Initialize deployments.json if not exists
          deployments_file = 'deployments.json'
          try:
              with open(deployments_file, 'r') as f:
                  deployments = json.load(f)
          except (FileNotFoundError, json.JSONDecodeError):
              deployments = []

          new_deployment = {
              "repo": repo_name,
              "version": version,
              "branch": branch,
              "status": status,
              "timestamp": timestamp
          }

          # Find and update existing repo or add new one
          existing_index = None
          for i, dep in enumerate(deployments):
              if dep.get("repo") == repo_name:
                  existing_index = i
                  break

          if existing_index is not None:
              deployments[existing_index] = new_deployment
          else:
              deployments.append(new_deployment)

          # Sort by timestamp descending
          deployments.sort(key=lambda x: x.get("timestamp", ""), reverse=True)

          # Write with proper formatting
          with open(deployments_file, 'w') as f:
              json.dump(deployments, f, indent=2)
              f.write('\n')  # Add trailing newline

          print(f"Updated deployment for {repo_name}")
          PYTHON_EOF
          python3 update_deployments.py
      
      - name: Update index.html with deployment status
        run: |
          cat > update_index.py << 'PYTHON_EOF'
          import json
          import re
          from datetime import datetime

          deployments_file = 'deployments.json'
          index_file = 'index.html'

          # Read deployments
          try:
              with open(deployments_file, 'r') as f:
                  deployments = json.load(f)
          except (FileNotFoundError, json.JSONDecodeError):
              deployments = []

          # Generate deployment status HTML
          lines = []
          lines.append('    <div class="section">')
          lines.append('        <h2>Deployment Status</h2>')
          lines.append('        <div class="deployment-grid">')

          if deployments:
              for dep in deployments:
                  try:
                      timestamp = dep.get("timestamp", "")
                      dt = datetime.fromisoformat(timestamp.replace('Z', '+00:00'))
                      formatted_time = dt.strftime('%Y-%m-%d %H:%M:%S UTC')
                  except (ValueError, AttributeError):
                      formatted_time = timestamp

                  status_badge = '✅' if dep.get("status") == "success" else '❌'
                  
                  lines.append('            <div class="deployment-card">')
                  lines.append(f'                <h3>{dep.get("repo", "Unknown")}</h3>')
                  lines.append(f'                <p><strong>Version:</strong> {dep.get("version", "N/A")}</p>')
                  lines.append(f'                <p><strong>Branch:</strong> {dep.get("branch", "N/A")}</p>')
                  lines.append(f'                <p><strong>Status:</strong> {status_badge} {dep.get("status", "unknown")}</p>')
                  lines.append(f'                <p><strong>Updated:</strong> {formatted_time}</p>')
                  lines.append('            </div>')
          else:
              lines.append('            <div style="padding: 40px 20px; text-align: center; color: #999; grid-column: 1/-1;">')
              lines.append('                <p>No deployments tracked yet. Trigger the workflow to start tracking!</p>')
              lines.append('            </div>')

          lines.append('        </div>')
          lines.append('    </div>')

          deployment_html = '\n'.join(lines)

          # Read current index.html
          with open(index_file, 'r', encoding='utf-8') as f:
              html_content = f.read()

          # Find and replace the deployment section
          pattern = r'<div class="section">\s*<h2>Deployment Status</h2>.*?</div>\s*</div>'

          if re.search(pattern, html_content, re.DOTALL):
              html_content = re.sub(pattern, deployment_html, html_content, count=1, flags=re.DOTALL)
              print("Updated existing deployment section")
          else:
              # Add before closing main tag if section doesn't exist
              if '</main>' in html_content:
                  indent = '        '
                  html_to_insert = indent + deployment_html.replace('\n', '\n' + indent)
                  html_content = html_content.replace('</main>', '\n' + html_to_insert + '\n    </main>')
                  print("Added new deployment section")
              else:
                  print("Warning: Could not find </main> tag in index.html")

          with open(index_file, 'w', encoding='utf-8') as f:
              f.write(html_content)
          PYTHON_EOF
          python3 update_index.py
      
      - name: Verify changes
        run: |
          echo "=== deployments.json ===" 
          cat deployments.json
          echo ""
          echo "=== Checking index.html ===" 
          grep -c "deployment-grid" index.html && echo "✓ Deployment section found in index.html" || echo "✗ Deployment section missing"
      
      - name: Cleanup temporary files
        run: rm -f update_deployments.py update_index.py
      
      - name: Commit and push changes
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          git add deployments.json index.html
          
          if ! git diff --quiet --staged; then
            git commit -m "chore: update deployment status [skip ci]"
            git push origin ${{ github.ref_name }}
            echo "✓ Changes pushed successfully"
          else
            echo "ℹ No changes to commit"
          fi
